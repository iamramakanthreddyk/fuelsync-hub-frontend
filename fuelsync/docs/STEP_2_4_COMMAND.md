# STEP\_2\_4\_COMMAND.md — Nozzle Readings + Auto Sales Generation

## ✅ Project Context Summary

FuelSync Hub is a fuel station ERP system where each nozzle reading is a cumulative value. Sales entries are automatically generated by calculating deltas between consecutive readings. Each sale uses the price effective at the reading time.

## 📌 Prior Steps Implemented

* ✅ `STEP_2_3`: Station, pump, and nozzle APIs + plan enforcement
* ✅ `STEP_2_2`: Tenant user management
* ✅ `STEP_2_1`: Auth, JWT, role middleware
* ✅ Phase 1: Full database schema with `nozzle_readings`, `sales`, `fuel_prices`

## 🚧 What to Build Now

### 1. Endpoint: `POST /api/nozzle-readings`

* Fields: `nozzle_id`, `reading`, `recorded_at`
* Must validate:

  * Reading is >= last value for that nozzle
  * Same nozzle and tenant context
* On insert, auto-generate delta:

  ```ts
  volume_sold = new_reading - previous_reading
  sale_amount = volume_sold × price_at(recorded_at)
  ```
* Insert resulting row into `sales` table

### 2. Delta Logic

* Load last reading (if exists)
* Load price using:

  ```sql
  SELECT price FROM fuel_prices
  WHERE fuel_type = nozzle.fuel_type
  AND station_id = nozzle.station_id
  AND effective_from <= recorded_at
  ORDER BY effective_from DESC
  LIMIT 1;
  ```
* Round sale to 2 decimals

### 3. Endpoint: `GET /api/nozzle-readings`

* Filter by station, nozzle, or date range
* Must enforce station access for current user

## 📁 File Paths

```
src/
├── controllers/nozzleReading.controller.ts
├── routes/nozzleReading.route.ts
├── services/nozzleReading.service.ts
├── validators/nozzleReading.validator.ts
```

## 🧠 Why This Step

Nozzle readings are the operational backbone. Sales are never entered manually — they’re derived. This enforces accountability and ensures pricing alignment.

## 🧾 Docs To Update

* `CHANGELOG.md`: Feature — nozzle reading API + sales auto-generation
* `PHASE_2_SUMMARY.md`: Mark step complete
* `IMPLEMENTATION_INDEX.md`: Add STEP\_2\_4 with links
* `BUSINESS_RULES.md`: Confirm rules for reading deltas + pricing

---

> Once saved, execute changes in defined files and document all results before advancing.
